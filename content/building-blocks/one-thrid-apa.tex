\subsection{Weak/Approximate Agreement against a $(1/3)$-Bounded Adversary}
\label{subsec:apa-one-third}

We first provide a simple protocol that solves Weak/Approximate Agreement against an adversary that controls up to one-third of the computational power.
%
At a high level, in this protocol parties first use \mforone PoW to mine and exchange messages containing their input value (concatenated with a random string for uniqueness) for a pre-determined number of $\ell$ rounds; then each party \party decides its output locally based on the messages that it has received.

The protocol is parameterized by $\ell$ (the termination time), $m$ (the number of parallel mining procedures) and $T$ (a pre-determined PoW target value).
%
A party \party starting with input $v$ queries the RO and gets $u = H(r \concat v)$ where $r$ is a $\kappa$-bit random string.
%
For every ``chunk'' \stringSegment{u}{i}{m} of $\kappa / m$ bits, \party checks if $\stringSegment{u}{i}{m} < T$.
%
If \party solves a PoW in any of the chunks, it diffuses $(r, v)$ to the network.
%
Note that $(r, v)$ will be counted independently for different succeeding chunks; e.g., if a valid PoW is found in $m / 2$ segments, $(r, v)$ will be counted for $m / 2$ times.
%
Parties keep listening to the network and book-keep all valid PoW messages, extracting their corresponding values in an array \textbf{V}.

Parties decide their output based on their local array \textbf{V} at the end of round $\ell$.
%
For Weak Agreement, they output $0$ ($1$ resp.) iff. more than two-thirds of the elements in \textbf{V} are $0$s ($1$s resp.); and $\bot$ otherwise.
%
Regarding Approximate Agreement, the output decision procedure then follows the approach in~\cite{JACM:DLPSW86}:
%
For an ordered array \textbf{V} of size $n$, the smallest and largest $n / 3$ values are dropped and the party outputs the midpoint of the remaining values (i.e., the average of the maximum and minimum element).

The full description of the protocol is presented in~\cref{protocol:one-third-approximate-consensus}.

\input{protocols/approx-agr-one-third}

Note that different parties may work on different sets of messages when the adversary chooses to hold and deliver its own PoW message at the last round (so that honest parties have no time to diffuse this message to others).
%
Nonetheless, for sufficiently large $\kappa$ and suitable value of $\ell$, the messages generated by different parties are roughly proportional to their computational power.
%
Thus, for all arrays held by honest parties, they will share a large (yet unknown) common subset.

\begin{lemma} \label{lemma:one-third-apa}
    Let \delay denote the upper bound on network delay, $h$ and $t$ denote the number of honest and adversarial queries per round ($h > 2t$), and $m$ be the number of independent PoW mining.
    %
    Let $V$ denote the honest input set ($V = \{0, 1\}$ for Weak Agreement and $V \subseteq \mathbb{R}$ for Approximate Agreement) and $\mathbf{V}$ denote the ordered array of PoW messages received by party \party after round $\ell$ (line~\ref*{code:ordered-array} in~\cref{protocol:one-third-approximate-consensus}), and assume that $\ell > 4 \delay$ and $m = \bigTheta(\log^2 \kappa)$.
    %
    Then, for any two honest parties $\party, \party'$ (possibly $\party = \party'$) and $\mathbf{V}, \mathbf{V}'$ with size $n, n'$, respectively, it holds that
    %
    \[ \min V \le \mathbf{V}_{n / 3} \le \mathbf{V}'_{2n' / 3} \le \max V, \]
    %
    except with probability negligible in $\kappa$.
\end{lemma}

\begin{proof}
    Let $\mathbf{V}^h \subseteq \mathbf{V}$ denote the subset of messages generated by the honest parties before round $\ell - \delay$.
    %
    Let $\mathcal{H}$ denote the set of honest parties at the end of round $\ell$, and suppose it holds that
    %
    \begin{equation} \label{eq:one-third-aa}
        \forall \party_j \in \mathcal{H}, \Big| \bigcap_{\party_i \in \mathcal{H}} \mathbf{V}^h_i \Big| \ge 2 |\mathbf{V}_j| / 3,
    \end{equation}
    %
    then for $\mathbf{V}$ held by any honest party, it would hold that $\min V \le \mathbf{V}_{n / 3} \le \med(\bigcap_{\party_i \in \mathcal{H}} \mathbf{V}^h_i) \le \mathbf{V}_{2n / 3} \le \max V$, which would conclude the proof.

    Now we only need to verify \cref{eq:one-third-aa}.
    %
    Let $X$ denote the number of PoW messages honest parties generated in the first $(\ell - \delay)$ rounds, and $Y$ denote the number of successful PoWs the adversary generated in the first $\ell$ rounds, plus all the honest PoWs in the last \delay rounds.
    %
    Since $\ell > 4 \delay$, we have $\EX[X] > \EX[2Y]$.
    %
    Note that $\EX[X] = \bigTheta(\EX[2Y]) = \bigTheta(\log^2 \kappa)$.
    %
    Now, by letting $\epsilon \in (0, (\EX[X] / \EX[2Y] - 1) / 2 )$ be a constant and applying the Chernoff bound (\cref{thm:chernoff-bounds}), we get
    %
    \[ \Pr[X > 2Y] \ge \Pr[X > (1 - \epsilon) \EX[X]] \wedge \Pr[2Y < (1 + \epsilon) \EX[2Y]] \ge 1 - \exp(-\bigOmega(\log^2 \kappa)), \]
    %
    which happens with overwhelming probability in $\kappa$, the security parameter.
\end{proof}

Given the good properties satisfied by $\mathbf{V}$ as described in~\cref{lemma:one-third-apa}, we conclude that (i) by comparing $\mathbf{V}_{n / 3}$ and $\mathbf{V}_{2n / 3}$, honest parties reach Weak Agreement; and (ii) by applying the mid-point on \textsf{reduce}, honest parties reach Approximate Agreement with concentration quality $1/2$.
%
We prove this for Approximate Agreement in~\cref{thm:apprx-agr-one-third} (and Weak Agreement can be argued alike).

\begin{theorem} \label{thm:apprx-agr-one-third}
    Under the same assumption as in~\cref{lemma:one-third-apa}, \cref{protocol:one-third-approximate-consensus} is a $(1/2)$-secure Approximate Agreement protocol against an adversary that controls less than one-third of the computational power, except with negligible probability in the security parameter.
\end{theorem}

\begin{proof}
    Validity follows directly, since for any honest party $\party_i$, all values in $\mathsf{reduce}(\mathbf{V}_i, |\mathbf{V}_i| / 3)$ are within the convex hull of the honest inputs, and so is the midpoint.

    Regarding $(1/2)$-Agreement, note that there exist a value $u$ such that for any honest party \party and $\mathbf{V}$,  $\mathbf{V}_{n / 3} \le u \le \mathbf{V}_{2n / 3}$ (cf.~\cref{lemma:one-third-apa}).
    %
    For any two honest parties \party and $\party'$ and their respective outputs $v, v'$, let $v_1, v_2$ ($v'_1, v'_2$, resp.) denote the smallest and largest values in $\mathsf{reduce}(\mathbf{V}_i, |\mathbf{V}_i| / 3)$ ($\mathsf{reduce}(\mathbf{V}'_i, |\mathbf{V}'_i| / 3)$, resp.).
    %
    We have
    %
    \[ |v - v'| = (|v_1 - v'_1|  + |v_2 - v'_2|)/ 2 \le (\max V - u + u - \min V|) / 2 = (\max V - \min V) / 2, \]
    %
    which concludes the proof.
\end{proof}

\begin{remark}
    We note that the output quality of a single invocation of AA as \cref{protocol:one-third-approximate-consensus} can be improved when the adversary controls less computational power.
    %
    This is in line with the classical AA algorithm by Dolev \textit{et al.} \cite{JACM:DLPSW86}.
\end{remark}

The output quality $\epsilon$ can be improved by calling the same Approximate Agreement protocol sequentially, with each invocation using the output of the previous one as input, resulting in $n$ sequential calls improving the output quality to $\epsilon' = \epsilon^n$.
%
In the classical setting(s) (point-to-point channels, or PKI), since deterministic termination is guaranteed, the sequential composition of AA protocols is trivial.
%
In a permissionless environment, however, where only a public setup is available, the sequential composition becomes more challenging in that a common reference string is needed for \emph{every} invocation in order to avoid pre-mining.
%
This problem has been addressed in~\cite{EC:GarKiaShe24} for the case of synchronous protocols (i.e., no [unknown] bounded delay) with static number of participants.
%
In~\cref{sec:permissionless-smr}, we show how this mechanism can be adapted to the drifting clock model with fluctuating number of parties.
